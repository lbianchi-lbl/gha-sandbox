on:
  workflow_call:
    inputs:
      repository:
        description: Repository to check out, in format <owner>/<name>
        type: string
        required: true
      ref:
        description: Git ref to use for installation
        type: string
        required: false
        default: main
      python-distr-name:
        description: Name of the Python distribution (i.e. PyPI name)
        type: string
        required: true
      os:
        description: OS key to map to valid GHA runner tag [linux, win64, macos]
        type: string
        required: true
      python-version:
        description: Python version
        type: string
        required: true
      install-variant:
        description: Under which variant the software should be installed
        type: string
        required: false
        default: dev

defaults:
  run:
    shell: bash {0}


env:
  PIP_PROGRESS_BAR: "off"
  PYTEST_ADDOPTS: color=yes

jobs:
  pytest:
    name: pytest/${{ inputs.os }}/py${{ inputs.python-version }}/${{ inputs.install-variant }}
    runs-on: ${{ fromJSON(vars.map_os_runner_json)[inputs.os] || inputs.os }}
    env:
      install_target: ${{ inputs.python-distr-name }} @ https://github.com/${{ inputs.repository }}/archive/${{ inputs.ref }}.zip
    steps:
      - name: Save inputs in job summary
        run: |
          cat <<'EOF' > $GITHUB_STEP_SUMMARY
          # This is a status update

          ## Inputs

          ```json
          ${{ toJSON(inputs) }}
          ```
          ---

          EOF
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python-version }}
      - name: Install ${{ inputs.repository }} using pip
        run: |
          pip install "$install_target"

          echo "## Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```sh" >> $GITHUB_STEP_SUMMARY
          echo "pip install $install_target" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          echo '## `idaes environment-info`' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```txt' >> $GITHUB_STEP_SUMMARY
          idaes environment-info >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
